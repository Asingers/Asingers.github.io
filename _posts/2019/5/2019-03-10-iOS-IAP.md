---
layout: post
title: iOS IAP
subtitle: iOS In-app Purchase
categories: iOS
header-mask: 0.7
tags: IAP

---
## å‰è¨€
æœ€è¿‘æœ‰æœ‹å‹é—®å†…è´­ç›¸å…³çš„ä¸œè¥¿ï¼Œå½“ç„¶è¿™æ˜¯ä¸€ä¸ªå·²ç»å­˜åœ¨å¾ˆä¹…çš„æŠ€æœ¯ç‚¹ï¼Œè‡ªå·±ä¹Ÿå­¦ä¹ äº†ä¸€ä¸‹ï¼Œè¶ç€è¿˜æœ‰ç‚¹çƒ­åº¦ï¼Œæ‰€ä»¥è®°å½•ä¸€ä¸‹è¿™ä¸ªå­¦ä¹ è¿‡ç¨‹ã€‚å½“ç„¶æ—¢å¤æ‚ä¹Ÿç®€å•ï¼Œå…¶å®å®˜æ–¹æ–‡æ¡£å·²ç»ç»™å‡ºäº†éå¸¸æƒå¨çš„è¯´æ˜ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæåŠ›æ¨èå®˜æ–¹æ–‡æ¡£å¿…é¡»çœ‹ä¸€çœ‹çš„åŸå› ï¼Œæ˜¯ä»€ä¹ˆå°±æ˜¯ä»€ä¹ˆï¼Œè¯´å¾—è·Ÿæ¸…æ¥šã€‚å½“ç„¶ä¹Ÿæœ‰ä¸€äº›ä¸æ¥åœ°æ°”çš„åœ°æ–¹ï¼Œéœ€è¦è‡ªå·±å†å®è·µä¸€ä¸‹ã€‚

> [In-App Purchase](https://developer.apple.com/in-app-purchase/)  
> 
> [In-App Purchase Programming Guide](https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/StoreKitGuide/Introduction.html?language=objc#//apple_ref/doc/uid/TP40008267)
>
> [Receipt Validation Programming Guide](https://developer.apple.com/library/archive/releasenotes/General/ValidateAppStoreReceipt/Introduction.html?language=objc#//apple_ref/doc/uid/TP40010573)
>
> [Best Practices and Whatâ€™s New with In-App Purchases](https://developer.apple.com/videos/play/wwdc2018/704/)
>
> [Subscriptions](https://developer.apple.com/app-store/subscriptions/)

ä¸Šè¾¹çš„å®˜æ–¹æ–‡æ¡£å…¶å®éƒ½åº”è¯¥è®¤çœŸçœ‹ä¸€çœ‹ã€‚

## æ¦‚å¿µ

IAP åˆ°åº•æ˜¯å•¥ç©æ„ï¼ŸIn-App Purchase å³åº”ç”¨å†…è´­ä¹°ï¼Œå¯ä»¥ç†è§£ä¸ºApple å¼€å‘çš„ä¸€å¥—éå¸¸æˆç†Ÿçš„B2C çš„æ¶ˆè´¹æ¨¡å¼ï¼Œå¹¶ä¸”æ•´ä¸ªè´­ä¹°è¿‡ç¨‹éƒ½å‘ç”Ÿåœ¨å®¿ä¸»App å†…ã€‚è¿™é‡Œä¹Ÿå¯ä»¥å¼•ç”³å‡ºApple å¯¹äºå†…è´­æ˜¯æœ‰ææˆçš„ï¼Œæ¯•ç«Ÿï¼Œå¼€å‘è¿™ä¸€å¥—ä¸œè¥¿å¯ä¸æ˜¯ç®€å•çš„ï¼Œè¿™å¯ä¸æ˜¯æˆ‘è¯´çš„ï¼Œè¿™æ˜¯Apple è‡ªå·±è¯´çš„ ğŸ˜‚æˆ‘ä¸ªäººè®¤ä¸ºApp Store ä¹‹æ‰€ä»¥èƒ½è¿™ä¹ˆå¼ºå¤§ï¼Œå¹¶ä¸”ç›ˆåˆ©å¾ˆèŒï¼ŒIAP è¿™å¥—ç³»ç»Ÿï¼Œæœ‰ç€å†³å®šæ€§çš„ä½œç”¨ã€‚

* å¯¹ç”¨æˆ·å…è´¹çš„ Appï¼ŒApple ä¸ä¼šæ”¶å–è´¹ç”¨ï¼› 
* ä¸“é—¨é€šè¿‡å¹¿å‘Šèµšé’±çš„ Appï¼Œå¦‚ç”¨æˆ·å–œæ¬¢çš„å…è´¹æ¸¸æˆç­‰ï¼ŒApple ä¸ä¼šæ”¶å–è´¹ç”¨ï¼› 
* ç”¨æˆ·åœ¨ app ä¹‹å¤–æ³¨å†Œæˆ–è´­ä¹°æ•°å­—å•†å“çš„ App ä¸šåŠ¡äº¤æ˜“ï¼ŒApple ä¸ä¼šæ”¶å–è´¹ç”¨ï¼›
* é”€å”®å®ä½“å•†å“çš„ App (åŒ…æ‹¬å«è½¦å’Œé€é¤æœåŠ¡)ï¼ŒApple ä¸ä¼šæ”¶å–è´¹ç”¨ã€‚

åªæœ‰ä½¿ç”¨æˆ‘ä»¬å®‰å…¨çš„ app å†…è´­ä¹°ç³»ç»Ÿï¼Œåœ¨ app å†…è´­ä¹°æ•°å­—å•†å“å’ŒæœåŠ¡ï¼ŒApple æ‰ä¼šè¦æ±‚æ”¶å–è´¹ç”¨ã€‚ä¹Ÿå°±æ˜¯å¸¸è¯´çš„ææˆã€‚

æ¥ä¸‹æ¥è¯•ç€ç†è§£ä¸€ä¸‹ä¸Šè¾¹æåˆ°çš„å•†å“ï¼Œä¸»è¦åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š

* æ¶ˆè€—å‹ã€‚å¯ä»¥è´­ä¹°å¤šæ¬¡ã€‚å³ç”¨å³ä¹°
* éæ¶ˆè€—å‹ã€‚åªèƒ½è´­ä¹°ä¸€æ¬¡ï¼Œä¹Ÿåªéœ€è¦è´­ä¹°ä¸€æ¬¡ã€‚æ¯”å¦‚æ¸¸æˆä¸­çš„æŸä¸ªäººç‰©ï¼ŒæŸä¸ªéœ€è¦ä»˜è´¹è§£é”çš„èµ›é“ã€‚
* è‡ªåŠ¨ç»­æœŸè®¢é˜…ã€‚å…¸å‹çš„æ˜¯è¿ç»­åŒ…æœˆçš„ä¼šå‘˜ã€‚
* éç»­æœŸè®¢é˜…ã€‚å…¸å‹çš„æŸæŸè§†é¢‘æ˜¯ä¸€ä¸ªæœˆä¼šå‘˜ï¼Œè¿™é‡Œæ³¨æ„åŒºåˆ«ä¸€ä¸‹ï¼Œä»–çš„ç‰¹ç‚¹æ˜¯åªèƒ½ä½¿ç”¨ä¸€ä¸ªæœˆï¼Œåˆ°æœŸå³ç»“æŸ

| ç±»å‹         | æ¶ˆè€—å‹   | éæ¶ˆè€—å‹ | è‡ªåŠ¨ç»­æœŸè®¢é˜… | éç»­æœŸè®¢é˜…  |
|--------------|----------|----------|--------------|-------------|
| è´­ä¹°æ¬¡æ•°     | å¤šæ¬¡     | ä¸€æ¬¡     | å¤šæ¬¡         | å¤šæ¬¡        |
| æ”¶æ®å‡ºç°æ¬¡æ•° | ä¸€æ¬¡     | ä¸€ç›´å­˜åœ¨ | ä¸€ç›´å­˜åœ¨     | ä¸€ç›´å­˜åœ¨    |
| è®¾å¤‡åŒæ­¥     | ä¸ä¼šåŒæ­¥ | ç³»ç»ŸåŒæ­¥ | ç³»ç»ŸåŒæ­¥     | Appè‡ªå·±å¤„ç† |
| æ¢å¤         | ä¸ä¼šæ¢å¤ | ç³»ç»Ÿæ¢å¤ | ç³»ç»Ÿæ¢å¤     | Appè‡ªå·±å¤„ç† |

å…¶ä¸­ï¼Œè®¢é˜…ã€‚åœ¨æˆ‘çš„å°è±¡ä¸­å¥½åƒæœ€è¿‘ä¸¤å¹´æ‰é€æ¸æµè¡Œèµ·æ¥ï¼Œä¹Ÿæ˜¯Apple ä¸»æ¨çš„ä¸€ç§æ¨¡å¼ã€‚æ™®é€šçš„å†…è´­å•†å“æ‰‹ç»­è´¹æ˜¯30%ï¼Œè€Œè®¢é˜…è¶…è¿‡ä¸€å¹´çš„ç”¨æˆ·ï¼Œæ‰‹ç»­è´¹åˆ™é™ä½åˆ°15%ã€‚å¹¶è¿˜å¯ä»¥è¿›è¡Œä¼˜æƒ ä¿ƒé”€æ´»åŠ¨ã€‚

### Introductory Offers

[è‡ªåŠ¨ç»­æœŸè®¢é˜… - App Store - Apple Developer](https://developer.apple.com/cn/app-store/subscriptions/?cid=win-back-subscribers-asc-w-cn#offering-introductory-prices)
å…¶ä¸­å…è´¹è¯•ç”¨æ˜¯å¤§éƒ¨åˆ†App åœ¨ä½¿ç”¨çš„ä¸€ç§æ–¹æ³•ï¼Œå…è´¹è¯•ç”¨æ—¶é—´ç»“æŸåå°±éœ€è¦è¿›è¡Œè®¢é˜…äº†ã€‚è¿™ä¸ªæ˜¯å¦æ­£åœ¨äº«å—ä¼˜æƒ ä¹Ÿå¯ä»¥åœ¨å†…è´­å‡­è¯ä¸­éªŒè¯ã€‚ä¸‹è¾¹ä¸¤ä¸ªKey çš„å€¼ï¼Œå½“æœ‰ä¸€ä¸ªä¸ºYESï¼Œé‚£ä¹ˆå°±è¯´æ˜å½“å‰ç”¨æˆ·æ­£åœ¨äº«å—ä¼˜æƒ 

* is_in_intro_offer_period æ˜¯å¦åœ¨äº«å—æŠ˜æ‰£ä»·
* is_trial_period æ˜¯å¦æ˜¯å…è´¹è¯•ç”¨

å…¶ä¸­App Storeæ¨å¹¿ ä¹Ÿè¢«è¶Šæ¥è¶Šå¤šçš„åº”ç”¨ï¼Œå³åœ¨App Store æœç´¢ç»“æœä¸­å‡ºç°ç›¸å…³ä¿ƒé”€ï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥ç‚¹å‡»å¹¶è°ƒèµ·App è¿›è¡Œä»˜è´¹ï¼Œç›¸å½“æ–¹ä¾¿ã€‚è¿™é‡Œéœ€è¦å®ç°ç›¸å…³ä»£ç†æ–¹æ³•ã€‚

### ä»£ç æ€ä¹ˆå†™

å…·ä½“è·¯ç¨‹ä¸å†èµ˜è¿°ï¼Œä¹Ÿæœ‰å¤§é‡çš„Sample Code å¯ä»¥ç›´æ¥æ‹¿è¿‡æ¥ç”¨ï¼Œæ€»ç»“ä¸€ä¸‹å¤§æ¦‚æ˜¯ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ã€‚
StoreKit æä¾›äº†æ ¸å¿ƒAPI SKPaymentQueueï¼Œæˆ‘ä»¬çš„æ“ä½œéƒ½å›´ç»•è¿™ä¸ªä¸œè¥¿ï¼Œç„¶åå…³æ³¨ä»£ç†æ–¹æ³•å°±å¯ä»¥äº†ã€‚

* Appé€šè¿‡SKProductRequestæ¥è¯·æ±‚å•†å“
* é€šè¿‡SKProductsRequestDelegateä¸­çš„ä»£ç†æ–¹æ³•ï¼Œè·å¾—SKProduct
* ç”¨SKProductç”ŸæˆSKMutablePaymentï¼Œæ·»åŠ åˆ°SKPaymentQueueé‡Œ
* é€šè¿‡SKPaymentTransactionObserverä¸­çš„ä»£ç†æ–¹æ³•ï¼Œè·å¾—æ­£åœ¨è´­ä¹°çš„å›è°ƒ
* é€šè¿‡SKPaymentTransactionObserverä¸­çš„ä»£ç†æ–¹æ³•ï¼Œè·å¾—æ­£åœ¨è´­ä¹°æˆåŠŸçš„å›è°ƒ
* Appç”¨æœ¬åœ°çš„æ”¶æ®å’Œç”¨æˆ·ID ç­‰ä¿¡æ¯ï¼Œé€šçŸ¥æœåŠ¡ç«¯IAP è´­ä¹°æˆåŠŸ
* æœåŠ¡ç«¯å‘é€æ”¶æ®åˆ°App Storeï¼ŒéªŒè¯æ”¶æ®
* App Store è¿”å›éªŒè¯æ”¶æ®çš„ç»“æœ
* æœåŠ¡ç«¯ä¸ºç”¨æˆ·å‘æ”¾å•†å“
* æœåŠ¡å•é€šçŸ¥å®¢æˆ·ç«¯ç»“æœ
* å®¢æˆ·ç«¯å®ŒæˆSKPaymentTransaction


å…¶ä¸­æœåŠ¡ç«¯å¹¶ä¸æ˜¯å¿…é¡»çš„ã€‚Apple æœ¬èº«å·²ç»æä¾›äº†æ”¶æ®éªŒè¯ï¼ŒåŒ…æ‹¬æœ¬åœ°éªŒè¯å’ŒApp Store éªŒè¯ï¼Œå½“ç„¶ä¸¥æ ¼æ„ä¹‰ä¸Šæ˜¯éœ€è¦æœ‰åç«¯ä½œæ ¡éªŒçš„ï¼Œå¯ä»¥ä½¿è´­ä¹°è¿‡ç¨‹æ›´åŠ ä¸¥è°¨ã€‚å…¶ä¸­è·å–æ”¶æ®ä¹‹åæ˜¯ä¼šå­˜å‚¨SanBox è·¯å¾„çš„
![](https://www.objc.io/images/issue-17/ReceiptLocation@2x-03dac061.png)
è·å–ï¼š

`NSBundle *mainBundle = [NSBundle mainBundle];
NSURL *receiptURL = [mainBundle appStoreReceiptURL];`

ä¸€ä¸ªæ”¶æ®è§£å‰–ä¸€ä¸‹çš„æ ·å­å¯ä»¥çœ‹ä¸‹å›¾
![](https://www.objc.io/images/issue-17/ReceiptStructure@2x-c1f06ab0.png)

éªŒè¯æ”¶æ®çš„è¿‡ç¨‹å¤§æ¦‚å¯ä»¥åˆ†ä¸ºï¼š

* æ‰¾åˆ°æ”¶æ®ã€‚ å¦‚æœæœªæ‰¾åˆ°æ”¶æ®ï¼Œåˆ™éªŒè¯å¤±è´¥ã€‚
* éªŒè¯æ”¶æ®çš„çœŸå®æ€§å’Œå®Œæ•´æ€§ã€‚ æ”¶æ®å¿…é¡»ç”±Appleæ­£ç¡®ç­¾åï¼Œä¸å¾—è¢«ç¯¡æ”¹ã€‚
* è§£ææ”¶æ®ä»¥æå–åŒ…æ ‡è¯†ç¬¦ï¼ŒåŒ…ç‰ˆæœ¬ç­‰å±æ€§ã€‚
* éªŒè¯åœ¨æ”¶æ®ä¸­æ‰¾åˆ°çš„åŒ…æ ‡è¯†ç¬¦æ˜¯å¦ä¸åº”ç”¨ç¨‹åºçš„åŒ…æ ‡è¯†ç¬¦åŒ¹é…ã€‚ å¯¹æ†ç»‘ç‰ˆæœ¬æ‰§è¡Œç›¸åŒæ“ä½œã€‚
* è®¡ç®—è®¾å¤‡GUIDçš„å“ˆå¸Œå€¼ã€‚ è®¡ç®—çš„æ•£åˆ—åŸºäºç‰¹å®šäºè®¾å¤‡çš„ä¿¡æ¯ã€‚
* å¦‚æœä½¿ç”¨æ‰¹é‡è´­ä¹°è®¡åˆ’ï¼Œè¯·æ£€æŸ¥æ”¶æ®çš„åˆ°æœŸæ—¥æœŸã€‚

ç”±äºæœ¬åœ°å»è§£å¯†ä¸€ä¸ªæ”¶æ®éªŒè¯çš„è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥å»ºè®®ç›´æ¥ç”¨App Store éªŒè¯æ”¶æ®ã€‚å¯èƒ½å¾ˆå¤šäººä¸çŸ¥é“ï¼Œæ”¶æ®è¿™ä¸ªä¸œè¥¿ä¸å…‰æ˜¯éƒ¨ç½²äº†In-app Purchase æ‰ä¼šæœ‰ï¼Œæ™®é€šçš„ä¸‹è½½å®‰è£…ä¸€ä¸ªå…è´¹çš„app ä¹Ÿæ˜¯æœ‰æ”¶æ®çš„ã€‚

ç”±äºæœªä¸Šçº¿çš„App ç»Ÿä¸€ä½¿ç”¨SandBox ç¯å¢ƒè¿›è¡Œï¼Œæ‰€ä»¥å½“å¤„äºå®¡æ ¸æœŸé—´çš„App åœ¨è¿›è¡ŒReceipt éªŒè¯çš„æ—¶å€™éœ€è¦çœ‹status code æ˜¯å¦ä¸º *21007*ï¼Œæ˜¯åˆ™éœ€è¦åœ¨SandBox ç¯å¢ƒä¸­éªŒè¯ï¼Œå¦åˆ™æ˜¯ä¸€å®šä¼šè¢«æ‹’çš„ã€‚å› ä¸ºä¸¤ä¸ªç¯å¢ƒçš„URL æ˜¯ä¸ä¸€æ ·ã€‚

è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ˜¯è®¢é˜…åˆ¶çš„App,éœ€è¦åŠ ä¸Šä¸‹è¾¹ä¸¤ä¸ªç‚¹ï¼Œå¦åˆ™ä¹Ÿä¸€å®šä¼šè¢«æ‹’ã€‚

* App Storeçš„æè¿°ä¿¡æ¯é‡ŒåŠ ä¸Šã€Šè‡ªåŠ¨ç»­è´¹æœåŠ¡è¯´æ˜ã€‹
* Appå†…çš„å……å€¼ç•Œé¢æä¾›ä¸¤ä¸ªé“¾æ¥ï¼šä¼šå‘˜æœåŠ¡åè®®ï¼Œè‡ªåŠ¨ç»­è´¹æœåŠ¡è§„åˆ™ã€‚

å…ˆæ•´ç†åˆ°è¿™é‡Œï¼Œæƒ³åˆ°ä»€ä¹ˆå†è¡¥å……ã€‚

> [Receipt Validation Â· objc.io](https://www.objc.io/issues/17-security/receipt-validation/)
> 
> [å®˜æ–¹æ–‡æ¡£ Validating Receipts With the App Store](https://developer.apple.com/library/archive/releasenotes/General/ValidateAppStoreReceipt/Chapters/ValidateRemotely.html)  

ğ‘° ğ’ğ’ğ’—ğ’† ğ‘¨ğ’‘ğ’‘ğ’ğ’† . ğ‘·ğ’†ğ’‚ğ’„ğ’†!










